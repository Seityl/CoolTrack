var oe=Object.defineProperty,de=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var je=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable;var B=(n,h,c)=>h in n?oe(n,h,{enumerable:!0,configurable:!0,writable:!0,value:c}):n[h]=c,o=(n,h)=>{for(var c in h||(h={}))je.call(h,c)&&B(n,c,h[c]);if(Y)for(var c of Y(h))xe.call(h,c)&&B(n,c,h[c]);return n},d=(n,h)=>de(n,he(h));var M=(n,h,c)=>new Promise((b,S)=>{var s=i=>{try{a(c.next(i))}catch(p){S(p)}},R=i=>{try{a(c.throw(i))}catch(p){S(p)}},a=i=>i.done?b(i.value):Promise.resolve(i.value).then(s,R);a((c=c.apply(n,h)).next())});import{U as ue,u as me,r as y,e as V,al as pe,ax as ge,j as e,p as j,s as q,b as ve,a as v,o as u,aL as be,aM as fe,aN as Ce,az as ye,c as r,Y as Ne,aD as we,t as Se,aE as _e,aF as Ae}from"./index-BVgz5S1Z.js";import{o as K}from"./grid-BDn360O0.js";import{o as m}from"./card-M61IZ-ns.js";import{u as k}from"./text-field-BdL2Ghhu.js";import{C as F,u as $,g as D,v as N}from"./select-zRVOLDPi.js";import{e as Ee}from"./tooltip-CpFJOGu_.js";import{r as Fe}from"./text-area-D_lXyIGp.js";import{c as $e}from"./scroll-area-BFJ_QKUy.js";import{m as Q,d as W,P as A,f as w,b as X,T as x}from"./table-BoS2MLqU.js";import"./index-BOzX9VC4.js";import"./index-CCj3VUJF.js";import"./index-BxKdqQ_s.js";import"./get-subtree-upfGRcKy.js";const Ge=()=>{var G;const{id:n}=ue();console.log("Alert Name:",n);const h=decodeURIComponent(n||"default-alert-name");console.log("Decoded Alert Name:",h);const c=me(),[b,S]=y.useState(!1),[s,R]=y.useState(null),[a,i]=y.useState({}),[p,T]=y.useState({receiver_by_role:"",condition:""}),[f,z]=y.useState({field:"",operator:"==",value:""}),[I,Z]=y.useState(!1),{data:E,isLoading:ee}=V("Notification",{fields:["name","subject","enabled","channel","event","creation","document_type","message","condition","send_system_notification"],filters:[["name","=",n||""]],limit:1}),{data:De}=V("Notification Recipient",{fields:["receiver_by_role","condition"],filters:[["parent","=",n||""]]}),{data:U}=V("DocType",{fields:["name"],filters:[["name","in",["Sensor","Sensor Gateway"]],["istable","=",0]]}),{data:H}=V("Role",{fields:["name"],filters:[["name","in",["Administrator","System Manager","Maintenance Manager","Maintenance User"]]]}),{updateDoc:J,loading:O}=pe(),{deleteDoc:le,loading:L}=ge();y.useEffect(()=>{E&&E.length>0&&(R(E[0]),i(E[0]))},[E]);const ae=()=>M(void 0,null,function*(){if(n)try{yield J("Notification",n,a),S(!1)}catch(l){console.error("Error updating alert:",l)}}),ne=()=>M(void 0,null,function*(){if(n)try{yield le("Notification",n),c("/alerts")}catch(l){console.error("Error deleting alert:",l)}}),se=()=>M(void 0,null,function*(){if(!(!n||!s))try{yield J("Notification",n,{enabled:!s.enabled}),R(l=>l?d(o({},l),{enabled:!l.enabled}):null)}catch(l){console.error("Error toggling alert status:",l)}}),ie=l=>l?l.split(" and ").map(C=>{const g=C.trim().split(/\s+/);return{field:g[0].replace("doc.",""),operator:g[1],value:g[2].replace(/"/g,"")}}):[],re={Email:e.jsx(Ae,{}),SMS:e.jsx(_e,{}),"System Notification":e.jsx(Se,{})},P=[{value:"New",label:"Creation"},{value:"Cancel",label:"Rejection"},{value:"Value Change",label:"Value Change"},{value:"Custom",label:"Custom Event"}],te=[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:"greater than"},{value:"<",label:"less than"},{value:">=",label:"greater than or equal"},{value:"<=",label:"less than or equal"},{value:"in",label:"in list"},{value:"not in",label:"not in list"}],ce=[{label:"Status is Active",value:'doc.status == "Active"'},{label:"Value exceeds threshold",value:"doc.value > 100"},{label:"Date is in the past",value:"doc.date < frappe.utils.nowdate()"},{label:"Field is not empty",value:"doc.fieldname"}];if(ee||!s)return e.jsx(j,{justify:"center",align:"center",className:"h-[80vh]",children:e.jsx(q,{size:"3"})});const _=ie(s.condition);return e.jsxs(ve,{className:"bg-gray-50 p-4 md:p-6",children:[e.jsxs(j,{justify:"between",align:"center",mb:"6",children:[e.jsx(v,{size:"7",weight:"bold",children:s.subject}),e.jsxs(j,{gap:"3",children:[e.jsxs(u,{variant:"soft",color:s.enabled?"green":"gray",onClick:se,disabled:O,children:[s.enabled?e.jsx(be,{className:"mr-2"}):e.jsx(fe,{className:"mr-2"}),s.enabled?"Active":"Inactive"]}),b?e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"soft",color:"gray",onClick:()=>S(!1),children:"Cancel"}),e.jsx(u,{onClick:ae,disabled:O,children:O?e.jsx(q,{}):"Save Changes"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(u,{variant:"soft",onClick:()=>S(!0),children:[e.jsx(Ce,{className:"mr-2"})," Edit"]}),e.jsxs(u,{color:"red",onClick:ne,disabled:L,children:[L?e.jsx(q,{}):e.jsx(ye,{className:"mr-2"}),"Delete"]})]})]})]}),e.jsxs(K,{columns:{initial:"1",md:"2"},gap:"6",children:[e.jsxs(m,{children:[e.jsx(v,{size:"5",mb:"4",children:"Alert Details"}),b?e.jsxs(j,{direction:"column",gap:"4",children:[e.jsx(k,{placeholder:"Alert Subject",value:a.subject||"",onChange:l=>i(d(o({},a),{subject:l.target.value}))}),e.jsxs(F,{value:a.document_type||"",onValueChange:l=>i(d(o({},a),{document_type:l})),children:[e.jsx($,{placeholder:"Select Document Type"}),e.jsx(D,{children:U==null?void 0:U.map(l=>e.jsx(N,{value:l.name,children:l.name},l.name))})]}),e.jsxs(F,{value:a.channel||"Email",onValueChange:l=>i(d(o({},a),{channel:l})),children:[e.jsx($,{placeholder:"Select Channel"}),e.jsxs(D,{children:[e.jsx(N,{value:"Email",children:"Email"}),e.jsx(N,{value:"SMS",children:"SMS"}),e.jsx(N,{value:"System Notification",children:"System Notification"})]})]}),e.jsxs(F,{value:a.event||"New",onValueChange:l=>i(d(o({},a),{event:l})),children:[e.jsx($,{placeholder:"Select Trigger Event"}),e.jsx(D,{children:P.map(l=>e.jsx(N,{value:l.value,children:l.label},l.value))})]})]}):e.jsxs(j,{direction:"column",gap:"3",children:[e.jsxs(j,{gap:"2",align:"center",children:[e.jsx(r,{color:"gray",weight:"bold",children:"Document Type:"}),e.jsx(r,{children:s.document_type})]}),e.jsxs(j,{gap:"2",align:"center",children:[e.jsx(r,{color:"gray",weight:"bold",children:"Channel:"}),e.jsxs(j,{gap:"2",align:"center",children:[re[s.channel],e.jsx(r,{children:s.channel})]})]}),e.jsxs(j,{gap:"2",align:"center",children:[e.jsx(r,{color:"gray",weight:"bold",children:"Trigger:"}),e.jsx(r,{children:((G=P.find(l=>l.value===s.event))==null?void 0:G.label)||s.event})]}),e.jsxs(j,{gap:"2",align:"center",children:[e.jsx(r,{color:"gray",weight:"bold",children:"Created:"}),e.jsx(r,{children:new Date(s.creation).toLocaleString()})]})]})]}),e.jsxs(m,{children:[e.jsxs(j,{justify:"between",align:"center",mb:"4",children:[e.jsx(v,{size:"5",children:"Message Template"}),e.jsx(Ee,{content:"Show Jinja2 Help",children:e.jsx(u,{variant:"ghost",size:"1",onClick:()=>Z(!I),children:e.jsx(Ne,{})})})]}),b?e.jsxs(e.Fragment,{children:[I&&e.jsxs(m,{mb:"4",children:[e.jsx(v,{size:"3",mb:"2",children:"Jinja2 Template Help"}),e.jsx(r,{mb:"2",children:"You can use these variables and filters in your templates:"}),e.jsxs(K,{columns:"2",gap:"3",children:[e.jsxs(m,{children:[e.jsx(v,{size:"3",children:"Variables"}),e.jsxs(r,{as:"div",mb:"2",children:[e.jsx("code",{children:"doc"})," - The document object",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.nowdate()"})," - Current date",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.get_url()"})," - System URL"]})]}),e.jsxs(m,{children:[e.jsx(v,{size:"3",children:"Common Examples"}),ce.map((l,t)=>e.jsxs(u,{variant:"soft",onClick:()=>i(d(o({},a),{message:a.message?`${a.message}
${l.value}`:l.value})),className:"mb-2",children:[e.jsx(we,{className:"mr-2"})," ",l.label]},t))]})]})]}),e.jsx(Fe,{placeholder:`Example: Alert for {{ doc.name }}
Status: {{ doc.status }}
Value: {{ doc.value }}`,rows:8,value:a.message||"",onChange:l=>i(d(o({},a),{message:l.target.value}))})]}):e.jsx(m,{children:e.jsx($e,{style:{maxHeight:"300px"},children:e.jsx(r,{children:s.message})})})]}),e.jsxs(m,{children:[e.jsx(v,{size:"5",mb:"4",children:"Conditions"}),b?e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(W,{children:e.jsxs(A,{children:[e.jsx(w,{children:"Field"}),e.jsx(w,{children:"Operator"}),e.jsx(w,{children:"Value"}),e.jsx(w,{children:"Actions"})]})}),e.jsxs(X,{children:[_.map((l,t)=>e.jsxs(A,{children:[e.jsx(x,{children:l.field}),e.jsx(x,{children:l.operator}),e.jsx(x,{children:l.value}),e.jsx(x,{children:e.jsx(u,{variant:"ghost",color:"red",onClick:()=>{const C=[..._];C.splice(t,1),i(d(o({},a),{condition:C.map(g=>`doc.${g.field} ${g.operator} ${isNaN(Number(g.value))?`"${g.value}"`:g.value}`).join(" and ")}))},children:"Remove"})})]},t)),e.jsxs(A,{children:[e.jsx(x,{children:e.jsx(k,{placeholder:"Field name",value:f.field,onChange:l=>z(d(o({},f),{field:l.target.value}))})}),e.jsx(x,{children:e.jsxs(F,{value:f.operator,onValueChange:l=>z(d(o({},f),{operator:l})),children:[e.jsx($,{}),e.jsx(D,{children:te.map(l=>e.jsx(N,{value:l.value,children:l.label},l.value))})]})}),e.jsx(x,{children:e.jsx(k,{placeholder:"Value",value:f.value,onChange:l=>z(d(o({},f),{value:l.target.value}))})}),e.jsx(x,{children:e.jsx(u,{onClick:()=>{const l=[..._,f];i(d(o({},a),{condition:l.map(t=>`doc.${t.field} ${t.operator} ${isNaN(Number(t.value))?`"${t.value}"`:t.value}`).join(" and ")})),z({field:"",operator:"==",value:""})},children:"Add"})})]})]})]}),_.length>0&&e.jsxs(m,{mt:"4",children:[e.jsx(v,{size:"2",children:"Generated Condition"}),e.jsx(r,{as:"div",children:a.condition})]})]}):e.jsx(j,{direction:"column",gap:"3",children:_.length>0?_.map((l,t)=>e.jsx(m,{children:e.jsxs(j,{gap:"3",children:[e.jsx(r,{weight:"bold",children:l.field}),e.jsx(r,{children:l.operator}),e.jsx(r,{children:l.value})]})},t)):e.jsx(r,{color:"gray",children:"No conditions defined"})})]}),e.jsxs(m,{children:[e.jsx(v,{size:"5",mb:"4",children:"Recipients"}),b?e.jsx(e.Fragment,{children:e.jsxs(Q,{children:[e.jsx(W,{children:e.jsxs(A,{children:[e.jsx(w,{children:"Role"}),e.jsx(w,{children:"Condition"}),e.jsx(w,{children:"Actions"})]})}),e.jsxs(X,{children:[(a.recipients||[]).map((l,t)=>e.jsxs(A,{children:[e.jsx(x,{children:l.receiver_by_role}),e.jsx(x,{children:l.condition||"-"}),e.jsx(x,{children:e.jsx(u,{variant:"ghost",color:"red",onClick:()=>{const C=[...a.recipients||[]];C.splice(t,1),i(d(o({},a),{recipients:C}))},children:"Remove"})})]},t)),e.jsxs(A,{children:[e.jsx(x,{children:e.jsxs(F,{value:p.receiver_by_role,onValueChange:l=>T(d(o({},p),{receiver_by_role:l})),children:[e.jsx($,{placeholder:"Select Role"}),e.jsx(D,{children:H==null?void 0:H.map(l=>e.jsx(N,{value:l.name,children:l.name},l.name))})]})}),e.jsx(x,{children:e.jsx(k,{placeholder:"Condition (optional)",value:p.condition,onChange:l=>T(d(o({},p),{condition:l.target.value}))})}),e.jsx(x,{children:e.jsx(u,{onClick:()=>{i(d(o({},a),{recipients:[...a.recipients||[],p]})),T({receiver_by_role:"",condition:""})},disabled:!p.receiver_by_role,children:"Add"})})]})]})]})}):e.jsx(j,{direction:"column",gap:"3",children:(s.recipients||[]).length>0?(s.recipients||[]).map((l,t)=>e.jsx(m,{children:e.jsxs(j,{justify:"between",align:"center",children:[e.jsx(r,{weight:"bold",children:l.receiver_by_role}),e.jsx(r,{color:"gray",children:l.condition||"No condition"})]})},t)):e.jsx(r,{color:"gray",children:"No recipients defined"})})]})]})]})};export{Ge as default};

var xe=Object.defineProperty,me=Object.defineProperties;var ge=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var K=(o,r,l)=>r in o?xe(o,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):o[r]=l,a=(o,r)=>{for(var l in r||(r={}))pe.call(r,l)&&K(o,l,r[l]);if(W)for(var l of W(r))ve.call(r,l)&&K(o,l,r[l]);return o},t=(o,r)=>me(o,ge(r));var Q=(o,r,l)=>new Promise((E,$)=>{var i=x=>{try{u(l.next(x))}catch(j){$(j)}},m=x=>{try{u(l.throw(x))}catch(j){$(j)}},u=x=>x.done?E(x.value):Promise.resolve(x.value).then(i,m);u((l=l.apply(o,r)).next())});import{u as be,r as b,e as B,aB as fe,j as e,p as s,s as X,b as D,a as C,o as p,aC as ye,m as Y,q as T,c as d,aD as Ce,aE as _e,t as Se,aF as we,aG as Ne,U as Ae}from"./index-C04qYfe-.js";import{m as $e,b as Re,P as Z,f as ee}from"./tabs-DEgt-0wF.js";import{o as k}from"./grid-DlTU2srM.js";import{o as F}from"./card-C5T3GK1O.js";import{s as De,p as ke,g as Fe}from"./dialog-QXb7-LxA.js";import{C as q,u as H,g as L,v as A}from"./select-zUghpQEI.js";import{r as Ee}from"./text-area-Be0m9nCr.js";import{m as ne,d as ie,P as w,f as _,b as se,T as h}from"./table-BXFL9hTW.js";import{u as P}from"./text-field-CMR2eUSf.js";import{c as Ve}from"./scroll-area-C6CETP3U.js";import"./index-rTswdvp2.js";import"./index-CuX96acz.js";import"./index-DDgf8gTd.js";import"./get-subtree-DIlR1yYT.js";const Ze=()=>{const o=be(),[r,l]=b.useState(!1),[E,$]=b.useState("active"),[i,m]=b.useState({subject:"",document_type:"Sensor",channel:"Email",event:"Value Change",enabled:!0,message:"",recipients:[],condition:"",conditions:[],send_system_notification:!1}),[u,x]=b.useState({receiver_by_document_field:"",receiver_by_role:"",condition:""});b.useEffect(()=>{i.subject==="Sensor Reading"?f(n=>t(a({},n),{field:"last_temperature"})):i.subject==="Device Battery Level"?f(n=>t(a({},n),{field:"last_battery"})):i.subject==="Device Inactivity Status"&&f(n=>t(a({},n),{field:"last_heartbeat"}))},[i.subject]);const[j,f]=b.useState({field:"",operator:"==",value:""}),[Me,ze]=b.useState(!1),[y,V]=b.useState(1),[v,M]=b.useState([]),{data:z}=B("Sensor",{fields:["name","sensor_id","status"],filters:[["status","=","Active"]]}),{data:S,isLoading:le}=B("Notification",{fields:["name","subject","enabled","channel","event","creation","document_type"],filters:[["is_standard","=",0]]}),{data:I}=B("Role",{fields:["name"],filters:[["name","in",["Administrator","System Manager","Maintenance Manager","Maintenance User"]]]}),O=()=>{switch(y){case 1:return!!i.subject;case 2:return v.length>0;case 3:return i.conditions.length>0;case 4:return!!i.channel&&!!i.message;default:return!0}},{createDoc:ae,loading:J}=fe(),te=()=>Q(void 0,null,function*(){try{const n=v.length>0?`doc.name in [${v.map(g=>`"${g}"`).join(", ")}]`:"",c=i.conditions.map(g=>{const je=!isNaN(parseFloat(g.value))&&isFinite(Number(g.value))?g.value:`"${g.value}"`;return`doc.${g.field} ${g.operator} ${je}`}),N=[n,...c].filter(Boolean).join(" and ");let R="";i.subject==="Sensor Reading"?R="last_temperature":i.subject==="Device Battery Level"?R="last_battery":i.subject==="Device Inactivity Status"&&(R="last_heartbeat"),yield ae("Notification",t(a({},i),{value_changed:R,condition:N,recipients:i.recipients.map(g=>t(a({},g),{doctype:"Notification Recipient"}))})),l(!1),m({subject:"",document_type:"Sensor",channel:"Email",event:"Value Change",enabled:!0,message:"",recipients:[],condition:"",conditions:[],send_system_notification:!1}),M([]),V(1)}catch(n){console.error("Error creating alert:",n)}}),re=()=>{!u.receiver_by_document_field&&!u.receiver_by_role||(m(n=>t(a({},n),{recipients:[...n.recipients,u]})),x({receiver_by_document_field:"",receiver_by_role:"",condition:""}))},ce=n=>{m(c=>t(a({},c),{recipients:c.recipients.filter((G,N)=>N!==n)}))},oe=()=>{j.field&&(m(n=>t(a({},n),{conditions:[...n.conditions,j]})),f({field:"",operator:"==",value:""}))},de=n=>{m(c=>t(a({},c),{conditions:c.conditions.filter((G,N)=>N!==n)}))},U={Email:e.jsx(Ne,{}),SMS:e.jsx(we,{}),"System Notification":e.jsx(Se,{})},he=[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:"greater than"},{value:"<",label:"less than"},{value:">=",label:"greater than or equal"},{value:"<=",label:"less than or equal"},{value:"in",label:"in list"},{value:"not in",label:"not in list"}],ue=()=>{switch(y){case 1:return e.jsxs(s,{direction:"column",gap:"4",children:[e.jsx(C,{size:"4",children:"Select Alert Type"}),e.jsx(d,{color:"gray",children:"Choose what type of alert you want to create"}),e.jsx(k,{columns:"1",gap:"3",children:["Sensor Reading","Device Battery Level","Device Inactivity Status"].map(n=>e.jsx(F,{className:`cursor-pointer hover:bg-gray-50 ${i.subject===n?"border-blue-500 border-2":""}`,onClick:()=>m(t(a({},i),{subject:n})),children:e.jsxs(s,{align:"center",gap:"3",children:[e.jsx(D,{className:"p-2 bg-blue-50 rounded-full",children:e.jsx(Ae,{className:"text-blue-500"})}),e.jsx(d,{weight:"medium",children:n})]})},n))})]});case 2:return e.jsxs(s,{direction:"column",gap:"4",children:[e.jsx(C,{size:"4",children:"Select Devices"}),e.jsx(d,{color:"gray",children:"Choose which sensors this alert will monitor"}),e.jsx(Ve,{style:{maxHeight:300},children:e.jsx(k,{columns:"2",gap:"2",children:z==null?void 0:z.map(n=>e.jsx(F,{className:`cursor-pointer ${v.includes(n.name)?"bg-blue-50 border-blue-500":""}`,onClick:()=>{v.includes(n.name)?M(v.filter(c=>c!==n.name)):M([...v,n.name])},children:e.jsxs(s,{justify:"between",align:"center",children:[e.jsx(d,{weight:"medium",children:n.sensor_id}),e.jsx(T,{color:v.includes(n.name)?"blue":"gray",children:v.includes(n.name)?"Selected":"Not Selected"})]})},n.name))})})]});case 3:return e.jsxs(s,{direction:"column",gap:"4",children:[e.jsx(C,{size:"4",children:"Set Conditions"}),e.jsx(d,{color:"gray",children:"Define when this alert should trigger"}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsxs(w,{children:[e.jsx(_,{children:"Field"}),e.jsx(_,{children:"Operator"}),e.jsx(_,{children:"Value"}),e.jsx(_,{children:"Actions"})]})}),e.jsxs(se,{children:[i.conditions.map((n,c)=>e.jsxs(w,{children:[e.jsx(h,{children:n.field}),e.jsx(h,{children:n.operator}),e.jsx(h,{children:n.value}),e.jsx(h,{children:e.jsx(p,{variant:"ghost",color:"red",onClick:()=>de(c),children:"Remove"})})]},c)),e.jsxs(w,{children:[e.jsx(h,{children:e.jsx(P,{placeholder:"Field name",value:j.field,onChange:n=>f(t(a({},j),{field:n.target.value}))})}),e.jsx(h,{children:e.jsxs(q,{value:j.operator,onValueChange:n=>f(t(a({},j),{operator:n})),children:[e.jsx(H,{}),e.jsx(L,{children:he.map(n=>e.jsx(A,{value:n.value,children:n.label},n.value))})]})}),e.jsx(h,{children:e.jsx(P,{placeholder:"Value",value:j.value,onChange:n=>f(t(a({},j),{value:n.target.value}))})}),e.jsx(h,{children:e.jsx(p,{onClick:oe,children:"Add"})})]})]})]})]});case 4:return e.jsxs(s,{direction:"column",gap:"4",children:[e.jsx(C,{size:"4",children:"Configure Actions"}),e.jsxs(s,{direction:"column",gap:"3",children:[e.jsx(d,{weight:"bold",children:"Notification Channel"}),e.jsxs(q,{value:i.channel,onValueChange:n=>m(t(a({},i),{channel:n})),children:[e.jsx(H,{placeholder:"Select Channel"}),e.jsxs(L,{children:[e.jsx(A,{value:"Email",children:"Email"}),e.jsx(A,{value:"SMS",children:"SMS"}),e.jsx(A,{value:"System Notification",children:"System Notification"})]})]}),e.jsx(d,{weight:"bold",children:"Message Template"}),e.jsx(Ee,{placeholder:"Enter your message template...",rows:5,value:i.message,onChange:n=>m(t(a({},i),{message:n.target.value}))}),e.jsx(d,{weight:"bold",children:"Recipients"}),e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsxs(w,{children:[e.jsx(_,{children:"Role"}),e.jsx(_,{children:"Condition (optional)"}),e.jsx(_,{children:"Actions"})]})}),e.jsxs(se,{children:[i.recipients.map((n,c)=>e.jsxs(w,{children:[e.jsx(h,{children:n.receiver_by_role}),e.jsx(h,{children:n.condition}),e.jsx(h,{children:e.jsx(p,{variant:"ghost",color:"red",onClick:()=>ce(c),children:"Remove"})})]},c)),e.jsxs(w,{children:[e.jsx(h,{children:e.jsxs(q,{value:u.receiver_by_role,onValueChange:n=>x(t(a({},u),{receiver_by_role:n})),children:[e.jsx(H,{placeholder:"Select Role"}),e.jsx(L,{children:I==null?void 0:I.map(n=>e.jsx(A,{value:n.name,children:n.name},n.name))})]})}),e.jsx(h,{children:e.jsx(P,{placeholder:"Condition (optional)",value:u.condition,onChange:n=>x(t(a({},u),{condition:n.target.value}))})}),e.jsx(h,{children:e.jsx(p,{onClick:re,disabled:!u.receiver_by_role,children:"Add"})})]})]})]})]})]})}};return le?e.jsx(s,{justify:"center",align:"center",className:"h-[80vh]",children:e.jsx(X,{size:"3"})}):e.jsxs(D,{className:"bg-gray-50 p-4 md:p-6",children:[e.jsxs(s,{justify:"between",align:"center",mb:"6",children:[e.jsx(C,{size:"7",weight:"bold",children:"Alerts"}),e.jsxs(p,{onClick:()=>l(!0),children:[e.jsx(ye,{className:"mr-2"})," Create Alert"]})]}),e.jsxs($e,{value:E,onValueChange:n=>$(n),children:[e.jsxs(Re,{mb:"4",children:[e.jsx(Z,{value:"active",children:"Active"}),e.jsx(Z,{value:"inactive",children:"Inactive"})]}),e.jsxs(D,{children:[e.jsx(ee,{value:"active",children:e.jsx(k,{columns:{initial:"1",md:"2",lg:"3"},gap:"4",children:S==null?void 0:S.filter(n=>n.enabled).map(n=>e.jsx(Y.div,{whileHover:{y:-2},children:e.jsx(F,{children:e.jsxs(s,{direction:"column",gap:"3",children:[e.jsxs(s,{justify:"between",align:"center",children:[e.jsx(C,{size:"4",children:n.subject}),e.jsx(T,{color:n.enabled?"green":"gray",children:n.enabled?"Active":"Inactive"})]}),e.jsxs(s,{gap:"2",align:"center",children:[U[n.channel],e.jsx(d,{children:n.channel})]}),e.jsxs(s,{gap:"2",align:"center",children:[e.jsx(d,{color:"gray",children:"Trigger:"}),e.jsx(d,{children:n.event})]}),e.jsxs(s,{gap:"2",align:"center",children:[e.jsx(d,{color:"gray",children:"Type:"}),e.jsx(d,{children:n.document_type})]}),e.jsx(p,{variant:"soft",onClick:()=>o(`/alerts/${n.name}`),children:"View Details"})]})})},n.name))})}),e.jsx(ee,{value:"inactive",children:e.jsx(k,{columns:{initial:"1",md:"2",lg:"3"},gap:"4",children:S==null?void 0:S.filter(n=>!n.enabled).map(n=>e.jsx(Y.div,{whileHover:{y:-2},children:e.jsx(F,{children:e.jsxs(s,{direction:"column",gap:"3",children:[e.jsxs(s,{justify:"between",align:"center",children:[e.jsx(C,{size:"4",children:n.subject}),e.jsx(T,{color:n.enabled?"green":"gray",children:n.enabled?"Active":"Inactive"})]}),e.jsxs(s,{gap:"2",align:"center",children:[U[n.channel],e.jsx(d,{children:n.channel})]}),e.jsx(p,{variant:"soft",onClick:()=>o(`/alerts/${n.name}`),children:"View Details"})]})})},n.name))})})]})]}),e.jsx(De,{open:r,onOpenChange:l,children:e.jsxs(ke,{style:{maxWidth:800},children:[e.jsx(Fe,{children:"Create New Alert"}),e.jsx(s,{gap:"2",mb:"4",children:[1,2,3,4].map(n=>e.jsx(D,{className:`h-2 w-full rounded-full ${y>=n?"bg-blue-500":"bg-gray-200"}`},n))}),ue(),e.jsxs(s,{gap:"3",mt:"4",justify:"between",children:[e.jsx(s,{gap:"2",children:y>1&&e.jsxs(p,{variant:"soft",onClick:()=>V(y-1),children:[e.jsx(Ce,{})," Back"]})}),e.jsx(s,{gap:"2",children:y<4?e.jsxs(p,{onClick:()=>V(y+1),disabled:!O(),children:["Next ",e.jsx(_e,{})]}):e.jsx(p,{onClick:te,disabled:J||!O(),children:J?e.jsx(X,{}):"Create Alert"})})]})]})})]})};export{Ze as default};

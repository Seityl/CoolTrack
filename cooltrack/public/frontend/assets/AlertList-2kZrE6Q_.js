var he=Object.defineProperty,je=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var P=(c,t,s)=>t in c?he(c,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[t]=s,a=(c,t)=>{for(var s in t||(t={}))ue.call(t,s)&&P(c,s,t[s]);if(O)for(var s of O(t))me.call(t,s)&&P(c,s,t[s]);return c},r=(c,t)=>je(c,xe(t));var B=(c,t,s)=>new Promise((R,A)=>{var l=m=>{try{j(s.next(m))}catch(x){A(x)}},d=m=>{try{j(s.throw(m))}catch(x){A(x)}},j=m=>m.done?R(m.value):Promise.resolve(m.value).then(l,d);j((s=s.apply(c,t)).next())});import{u as ve,r as C,e as F,aB as pe,j as e,p as h,s as G,b as L,a as v,o as u,aC as ge,m as U,q as Y,c as p,Y as be,aD as W,t as fe,aE as Ce,aF as ye}from"./index-BVgz5S1Z.js";import{m as _e,b as Se,P as K,f as Q}from"./tabs-lF17Y1Kq.js";import{o as M}from"./grid-BDn360O0.js";import{o as y}from"./card-M61IZ-ns.js";import{s as we,p as $e,g as Ae,D as Ne}from"./dialog-Blvyg2X3.js";import{u as E}from"./text-field-BdL2Ghhu.js";import{C as S,u as w,g as $,v as g}from"./select-zRVOLDPi.js";import{e as Ee}from"./tooltip-CpFJOGu_.js";import{r as Re}from"./text-area-D_lXyIGp.js";import{m as X,d as Z,P as _,f as b,b as ee,T as o}from"./table-BoS2MLqU.js";import{o as Ve}from"./separator-BTa1UTzN.js";import"./index-BOzX9VC4.js";import"./index-CCj3VUJF.js";import"./scroll-area-BFJ_QKUy.js";import"./get-subtree-upfGRcKy.js";import"./index-BxKdqQ_s.js";const We=()=>{const c=ve(),[t,s]=C.useState(!1),[R,A]=C.useState("active"),[l,d]=C.useState({subject:"",document_type:"",channel:"Email",event:"New",enabled:!0,message:"",recipients:[],condition:"",conditions:[],send_system_notification:!1}),[j,m]=C.useState({receiver_by_document_field:"",receiver_by_role:"",condition:""}),[x,N]=C.useState({field:"",operator:"==",value:""}),[T,ne]=C.useState(!1),{data:f,isLoading:ie}=F("Notification",{fields:["name","subject","enabled","channel","event","creation","document_type"],filters:[["is_standard","=",0]]}),{data:V}=F("DocType",{fields:["name"],filters:[["name","in",["Sensor","Sensor Gateway"]],["istable","=",0]]}),{data:z}=F("Role",{fields:["name"],filters:[["name","in",["Administrator","System Manager","Maintenance Manager","Maintenance User"]]]}),{createDoc:se,loading:H}=pe(),le=()=>B(void 0,null,function*(){try{const n=l.conditions.map(i=>`doc.${i.field} ${i.operator} ${isNaN(Number(i.value))?`"${i.value}"`:i.value}`).join(" and ");yield se("Notification",r(a({},l),{condition:n,recipients:l.recipients.map(i=>r(a({},i),{doctype:"Notification Recipient"}))})),s(!1),d({subject:"",document_type:"",channel:"Email",event:"New",enabled:!0,message:"",recipients:[],condition:"",conditions:[],send_system_notification:!1})}catch(n){console.error("Error creating alert:",n)}}),ae=()=>{!j.receiver_by_document_field&&!j.receiver_by_role||(d(n=>r(a({},n),{recipients:[...n.recipients,j]})),m({receiver_by_document_field:"",receiver_by_role:"",condition:""}))},re=n=>{d(i=>r(a({},i),{recipients:i.recipients.filter((k,D)=>D!==n)}))},te=()=>{x.field&&(d(n=>r(a({},n),{conditions:[...n.conditions,x]})),N({field:"",operator:"==",value:""}))},ce=n=>{d(i=>r(a({},i),{conditions:i.conditions.filter((k,D)=>D!==n)}))},I={Email:e.jsx(ye,{}),SMS:e.jsx(Ce,{}),"System Notification":e.jsx(fe,{})},q=[{value:"New",label:"Creation"},{value:"Cancel",label:"Rejection"},{value:"Value Change",label:"Value Change"},{value:"Custom",label:"Custom Event"}],oe=[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:"greater than"},{value:"<",label:"less than"},{value:">=",label:"greater than or equal"},{value:"<=",label:"less than or equal"},{value:"in",label:"in list"},{value:"not in",label:"not in list"}],de=[{label:"Status is Active",value:'doc.status == "Active"'},{label:"Value exceeds threshold",value:"doc.value > 100"},{label:"Date is in the past",value:"doc.date < frappe.utils.nowdate()"},{label:"Field is not empty",value:"doc.fieldname"}],J=n=>{d(i=>r(a({},i),{message:i.message?`${i.message}
${n}`:n}))};return ie?e.jsx(h,{justify:"center",align:"center",className:"h-[80vh]",children:e.jsx(G,{size:"3"})}):e.jsxs(L,{className:"bg-gray-50 p-4 md:p-6",children:[e.jsxs(h,{justify:"between",align:"center",mb:"6",children:[e.jsx(v,{size:"7",weight:"bold",children:"Alerts"}),e.jsxs(u,{onClick:()=>s(!0),children:[e.jsx(ge,{className:"mr-2"})," Create Alert"]})]}),e.jsxs(_e,{value:R,onValueChange:n=>A(n),children:[e.jsxs(Se,{mb:"4",children:[e.jsx(K,{value:"active",children:"Active"}),e.jsx(K,{value:"inactive",children:"Inactive"})]}),e.jsxs(L,{children:[e.jsx(Q,{value:"active",children:e.jsx(M,{columns:{initial:"1",md:"2",lg:"3"},gap:"4",children:f==null?void 0:f.filter(n=>n.enabled).map(n=>{var i;return e.jsx(U.div,{whileHover:{y:-2},children:e.jsx(y,{children:e.jsxs(h,{direction:"column",gap:"3",children:[e.jsxs(h,{justify:"between",align:"center",children:[e.jsx(v,{size:"4",children:n.subject}),e.jsx(Y,{color:n.enabled?"green":"gray",children:n.enabled?"Active":"Inactive"})]}),e.jsxs(h,{gap:"2",align:"center",children:[I[n.channel],e.jsx(p,{children:n.channel})]}),e.jsxs(h,{gap:"2",align:"center",children:[e.jsx(p,{color:"gray",children:"Trigger:"}),e.jsx(p,{children:((i=q.find(k=>k.value===n.event))==null?void 0:i.label)||n.event})]}),e.jsxs(h,{gap:"2",align:"center",children:[e.jsx(p,{color:"gray",children:"Type:"}),e.jsx(p,{children:n.document_type})]}),e.jsx(u,{variant:"soft",onClick:()=>c(`/alerts/${n.name}`),children:"View Details"})]})})},n.name)})})}),e.jsx(Q,{value:"inactive",children:e.jsx(M,{columns:{initial:"1",md:"2",lg:"3"},gap:"4",children:f==null?void 0:f.filter(n=>!n.enabled).map(n=>e.jsx(U.div,{whileHover:{y:-2},children:e.jsx(y,{children:e.jsxs(h,{direction:"column",gap:"3",children:[e.jsxs(h,{justify:"between",align:"center",children:[e.jsx(v,{size:"4",children:n.subject}),e.jsx(Y,{color:n.enabled?"green":"gray",children:n.enabled?"Active":"Inactive"})]}),e.jsxs(h,{gap:"2",align:"center",children:[I[n.channel],e.jsx(p,{children:n.channel})]}),e.jsx(u,{variant:"soft",onClick:()=>c(`/alerts/${n.name}`),children:"View Details"})]})})},n.name))})})]})]}),e.jsx(we,{open:t,onOpenChange:s,children:e.jsxs($e,{style:{maxWidth:800},children:[e.jsx(Ae,{children:"Create New Alert"}),e.jsxs(h,{direction:"column",gap:"4",children:[e.jsx(E,{placeholder:"Alert Subject",value:l.subject,onChange:n=>d(r(a({},l),{subject:n.target.value}))}),e.jsxs(S,{value:l.document_type,onValueChange:n=>d(r(a({},l),{document_type:n})),children:[e.jsx(w,{placeholder:"Select Document Type"}),e.jsx($,{children:V==null?void 0:V.map(n=>e.jsx(g,{value:n.name,children:n.name},n.name))})]}),e.jsxs(S,{value:l.channel,onValueChange:n=>d(r(a({},l),{channel:n})),children:[e.jsx(w,{placeholder:"Select Channel"}),e.jsxs($,{children:[e.jsx(g,{value:"Email",children:"Email"}),e.jsx(g,{value:"SMS",children:"SMS"}),e.jsx(g,{value:"System Notification",children:"System Notification"})]})]}),e.jsxs(S,{value:l.event,onValueChange:n=>d(r(a({},l),{event:n})),children:[e.jsx(w,{placeholder:"Select Trigger Event"}),e.jsx($,{children:q.map(n=>e.jsx(g,{value:n.value,children:n.label},n.value))})]}),e.jsxs(h,{align:"center",gap:"2",children:[e.jsx(v,{size:"4",children:"Message Template"}),e.jsx(Ee,{content:"Show Jinja2 Help",children:e.jsx(u,{variant:"ghost",size:"1",onClick:()=>ne(!T),children:e.jsx(be,{})})})]}),T&&e.jsxs(y,{children:[e.jsx(v,{size:"3",mb:"2",children:"Jinja2 Template Help"}),e.jsx(p,{mb:"2",children:"You can use these variables and filters in your templates:"}),e.jsxs(M,{columns:"2",gap:"3",children:[e.jsxs(y,{children:[e.jsx(v,{size:"3",children:"Variables"}),e.jsxs(p,{as:"div",mb:"2",children:[e.jsx("code",{children:"doc"})," - The document object",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.nowdate()"})," - Current date",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.get_url()"})," - System URL"]}),e.jsxs(u,{variant:"soft",onClick:()=>J("Document: {{ doc.name }}"),children:[e.jsx(W,{className:"mr-2"})," Insert doc.name"]})]}),e.jsxs(y,{children:[e.jsx(v,{size:"3",children:"Common Examples"}),de.map((n,i)=>e.jsxs(u,{variant:"soft",onClick:()=>J(n.value),className:"mb-2",children:[e.jsx(W,{className:"mr-2"})," ",n.label]},i))]})]})]}),e.jsx(Re,{placeholder:`Example: Alert for {{ doc.name }}
Status: {{ doc.status }}
Value: {{ doc.value }}`,rows:5,value:l.message,onChange:n=>d(r(a({},l),{message:n.target.value}))}),e.jsx(v,{size:"4",children:"Conditions"}),e.jsx(p,{color:"gray",mb:"2",children:"Define when this alert should be triggered. All conditions must be true."}),e.jsxs(X,{children:[e.jsx(Z,{children:e.jsxs(_,{children:[e.jsx(b,{children:"Field"}),e.jsx(b,{children:"Operator"}),e.jsx(b,{children:"Value"}),e.jsx(b,{children:"Actions"})]})}),e.jsxs(ee,{children:[l.conditions.map((n,i)=>e.jsxs(_,{children:[e.jsx(o,{children:n.field}),e.jsx(o,{children:n.operator}),e.jsx(o,{children:n.value}),e.jsx(o,{children:e.jsx(u,{variant:"ghost",color:"red",onClick:()=>ce(i),children:"Remove"})})]},i)),e.jsxs(_,{children:[e.jsx(o,{children:e.jsx(E,{placeholder:"Field name",value:x.field,onChange:n=>N(r(a({},x),{field:n.target.value}))})}),e.jsx(o,{children:e.jsxs(S,{value:x.operator,onValueChange:n=>N(r(a({},x),{operator:n})),children:[e.jsx(w,{}),e.jsx($,{children:oe.map(n=>e.jsx(g,{value:n.value,children:n.label},n.value))})]})}),e.jsx(o,{children:e.jsx(E,{placeholder:"Value",value:x.value,onChange:n=>N(r(a({},x),{value:n.target.value}))})}),e.jsx(o,{children:e.jsx(u,{onClick:te,children:"Add"})})]})]})]}),l.conditions.length>0&&e.jsxs(y,{children:[e.jsx(v,{size:"2",children:"Generated Condition"}),e.jsx(p,{as:"div",children:l.conditions.map(n=>`doc.${n.field} ${n.operator} ${isNaN(Number(n.value))?`"${n.value}"`:n.value}`).join(" and ")})]}),e.jsx(Ve,{size:"4"}),e.jsx(v,{size:"4",children:"Recipients by Role"}),e.jsxs(X,{children:[e.jsx(Z,{children:e.jsxs(_,{children:[e.jsx(b,{children:"Role"}),e.jsx(b,{children:"Condition (optional)"}),e.jsx(b,{children:"Actions"})]})}),e.jsxs(ee,{children:[l.recipients.map((n,i)=>e.jsxs(_,{children:[e.jsx(o,{children:n.receiver_by_role}),e.jsx(o,{children:n.condition}),e.jsx(o,{children:e.jsx(u,{variant:"ghost",color:"red",onClick:()=>re(i),children:"Remove"})})]},i)),e.jsxs(_,{children:[e.jsx(o,{children:e.jsxs(S,{value:j.receiver_by_role,onValueChange:n=>m(r(a({},j),{receiver_by_role:n})),children:[e.jsx(w,{placeholder:"Select Role"}),e.jsx($,{children:z==null?void 0:z.map(n=>e.jsx(g,{value:n.name,children:n.name},n.name))})]})}),e.jsx(o,{children:e.jsx(E,{placeholder:"Condition (optional)",value:j.condition,onChange:n=>m(r(a({},j),{condition:n.target.value}))})}),e.jsx(o,{children:e.jsx(u,{onClick:ae,disabled:!j.receiver_by_role,children:"Add"})})]})]})]})]}),e.jsxs(h,{gap:"3",mt:"4",justify:"end",children:[e.jsx(Ne,{children:e.jsx(u,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsx(u,{onClick:le,disabled:H,children:H?e.jsx(G,{}):"Create Alert"})]})]})})]})};export{We as default};

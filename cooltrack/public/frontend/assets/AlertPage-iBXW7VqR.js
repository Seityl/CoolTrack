var ue=Object.defineProperty,me=Object.defineProperties;var pe=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var Y=(l,i,s)=>i in l?ue(l,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[i]=s,o=(l,i)=>{for(var s in i||(i={}))K.call(i,s)&&Y(l,s,i[s]);if(k)for(var s of k(i))X.call(i,s)&&Y(l,s,i[s]);return l},h=(l,i)=>me(l,pe(i));var Z=(l,i)=>{var s={};for(var d in l)K.call(l,d)&&i.indexOf(d)<0&&(s[d]=l[d]);if(l!=null&&k)for(var d of k(l))i.indexOf(d)<0&&X.call(l,d)&&(s[d]=l[d]);return s};var O=(l,i,s)=>new Promise((d,y)=>{var t=r=>{try{n(s.next(r))}catch(p){y(p)}},E=r=>{try{n(s.throw(r))}catch(p){y(p)}},n=r=>r.done?d(r.value):Promise.resolve(r.value).then(t,E);n((s=s.apply(l,i)).next())});import{af as I,r as u,D as ge,aM as ve,aN as fe,aO as be,aw as Ce,aP as ye,G as Ne,c,aQ as we,N as Se,u as Ee,e as H,al as _e,ax as Ae,j as e,p as x,s as J,b as Re,a as C,o as g,aR as Fe,aS as $e,aT as Te,az as De,U as Me,aU as ze,t as Ve,aF as ke,aG as Oe}from"./index-C04qYfe-.js";import{o as ee}from"./grid-DlTU2srM.js";import{o as v}from"./card-C5T3GK1O.js";import{u as P}from"./text-field-CMR2eUSf.js";import{C as T,u as D,g as M,v as w}from"./select-zUghpQEI.js";import{r as He}from"./text-area-Be0m9nCr.js";import{c as Pe}from"./scroll-area-C6CETP3U.js";import{m as ae,d as le,P as R,f as S,b as ne,T as m}from"./table-BXFL9hTW.js";import"./index-rTswdvp2.js";import"./index-CuX96acz.js";import"./index-DDgf8gTd.js";import"./get-subtree-DIlR1yYT.js";const Ue={content:{type:"ReactNode",required:!0},width:I.width,minWidth:I.minWidth,maxWidth:h(o({},I.maxWidth),{default:"360px"})},se=u.forwardRef((l,i)=>{const V=ge(l,Ue),{children:s,className:d,open:y,defaultOpen:t,onOpenChange:E,delayDuration:n,disableHoverableContent:r,content:p,container:F,forceMount:f}=V,_=Z(V,["children","className","open","defaultOpen","onOpenChange","delayDuration","disableHoverableContent","content","container","forceMount"]),z={open:y,defaultOpen:t,onOpenChange:E,delayDuration:n,disableHoverableContent:r};return u.createElement(ve,o({},z),u.createElement(fe,{asChild:!0},s),u.createElement(be,{container:F,forceMount:f},u.createElement(Ce,{asChild:!0},u.createElement(ye,h(o({sideOffset:4,collisionPadding:10},_),{asChild:!1,ref:i,className:Ne("rt-TooltipContent",d)}),u.createElement(c,{as:"p",className:"rt-TooltipText",size:"1"},p),u.createElement(we,{className:"rt-TooltipArrow"})))))});se.displayName="Tooltip";const la=()=>{var Q;const{id:l}=Se();console.log("Alert Name:",l);const i=decodeURIComponent(l||"default-alert-name");console.log("Decoded Alert Name:",i);const s=Ee(),[d,y]=u.useState(!1),[t,E]=u.useState(null),[n,r]=u.useState({}),[p,F]=u.useState({receiver_by_role:"",condition:""}),[f,_]=u.useState({field:"",operator:"==",value:""}),[z,V]=u.useState(!1),{data:$,isLoading:ie}=H("Notification",{fields:["name","subject","enabled","channel","event","creation","document_type","message","condition","send_system_notification"],filters:[["name","=",l||""]],limit:1}),{data:qe}=H("Notification Recipient",{fields:["receiver_by_role","condition"],filters:[["parent","=",l||""]]}),{data:U}=H("DocType",{fields:["name"],filters:[["name","in",["Sensor","Sensor Gateway"]],["istable","=",0]]}),{data:q}=H("Role",{fields:["name"],filters:[["name","in",["Administrator","System Manager","Maintenance Manager","Maintenance User"]]]}),{updateDoc:W,loading:G}=_e(),{deleteDoc:te,loading:L}=Ae();u.useEffect(()=>{$&&$.length>0&&(E($[0]),r($[0]))},[$]);const re=()=>O(void 0,null,function*(){if(l)try{yield W("Notification",l,n),y(!1)}catch(a){console.error("Error updating alert:",a)}}),oe=()=>O(void 0,null,function*(){if(l)try{yield te("Notification",l),s("/alerts")}catch(a){console.error("Error deleting alert:",a)}}),ce=()=>O(void 0,null,function*(){if(!(!l||!t))try{yield W("Notification",l,{enabled:!t.enabled}),E(a=>a?h(o({},a),{enabled:!a.enabled}):null)}catch(a){console.error("Error toggling alert status:",a)}}),de=a=>a?a.split(" and ").map(N=>{const b=N.trim().split(/\s+/);return{field:b[0].replace("doc.",""),operator:b[1],value:b[2].replace(/"/g,"")}}):[],he={Email:e.jsx(Oe,{}),SMS:e.jsx(ke,{}),"System Notification":e.jsx(Ve,{})},B=[{value:"New",label:"Creation"},{value:"Cancel",label:"Rejection"},{value:"Value Change",label:"Value Change"},{value:"Custom",label:"Custom Event"}],je=[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:"greater than"},{value:"<",label:"less than"},{value:">=",label:"greater than or equal"},{value:"<=",label:"less than or equal"},{value:"in",label:"in list"},{value:"not in",label:"not in list"}],xe=[{label:"Status is Active",value:'doc.status == "Active"'},{label:"Value exceeds threshold",value:"doc.value > 100"},{label:"Date is in the past",value:"doc.date < frappe.utils.nowdate()"},{label:"Field is not empty",value:"doc.fieldname"}];if(ie||!t)return e.jsx(x,{justify:"center",align:"center",className:"h-[80vh]",children:e.jsx(J,{size:"3"})});const A=de(t.condition);return e.jsxs(Re,{className:"bg-gray-50 p-4 md:p-6",children:[e.jsxs(x,{justify:"between",align:"center",mb:"6",children:[e.jsx(C,{size:"7",weight:"bold",children:t.subject}),e.jsxs(x,{gap:"3",children:[e.jsxs(g,{variant:"soft",color:t.enabled?"green":"gray",onClick:ce,disabled:G,children:[t.enabled?e.jsx(Fe,{className:"mr-2"}):e.jsx($e,{className:"mr-2"}),t.enabled?"Active":"Inactive"]}),d?e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"soft",color:"gray",onClick:()=>y(!1),children:"Cancel"}),e.jsx(g,{onClick:re,disabled:G,children:G?e.jsx(J,{}):"Save Changes"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(g,{variant:"soft",onClick:()=>y(!0),children:[e.jsx(Te,{className:"mr-2"})," Edit"]}),e.jsxs(g,{color:"red",onClick:oe,disabled:L,children:[L?e.jsx(J,{}):e.jsx(De,{className:"mr-2"}),"Delete"]})]})]})]}),e.jsxs(ee,{columns:{initial:"1",md:"2"},gap:"6",children:[e.jsxs(v,{children:[e.jsx(C,{size:"5",mb:"4",children:"Alert Details"}),d?e.jsxs(x,{direction:"column",gap:"4",children:[e.jsx(P,{placeholder:"Alert Subject",value:n.subject||"",onChange:a=>r(h(o({},n),{subject:a.target.value}))}),e.jsxs(T,{value:n.document_type||"",onValueChange:a=>r(h(o({},n),{document_type:a})),children:[e.jsx(D,{placeholder:"Select Document Type"}),e.jsx(M,{children:U==null?void 0:U.map(a=>e.jsx(w,{value:a.name,children:a.name},a.name))})]}),e.jsxs(T,{value:n.channel||"Email",onValueChange:a=>r(h(o({},n),{channel:a})),children:[e.jsx(D,{placeholder:"Select Channel"}),e.jsxs(M,{children:[e.jsx(w,{value:"Email",children:"Email"}),e.jsx(w,{value:"SMS",children:"SMS"}),e.jsx(w,{value:"System Notification",children:"System Notification"})]})]}),e.jsxs(T,{value:n.event||"New",onValueChange:a=>r(h(o({},n),{event:a})),children:[e.jsx(D,{placeholder:"Select Trigger Event"}),e.jsx(M,{children:B.map(a=>e.jsx(w,{value:a.value,children:a.label},a.value))})]})]}):e.jsxs(x,{direction:"column",gap:"3",children:[e.jsxs(x,{gap:"2",align:"center",children:[e.jsx(c,{color:"gray",weight:"bold",children:"Document Type:"}),e.jsx(c,{children:t.document_type})]}),e.jsxs(x,{gap:"2",align:"center",children:[e.jsx(c,{color:"gray",weight:"bold",children:"Channel:"}),e.jsxs(x,{gap:"2",align:"center",children:[he[t.channel],e.jsx(c,{children:t.channel})]})]}),e.jsxs(x,{gap:"2",align:"center",children:[e.jsx(c,{color:"gray",weight:"bold",children:"Trigger:"}),e.jsx(c,{children:((Q=B.find(a=>a.value===t.event))==null?void 0:Q.label)||t.event})]}),e.jsxs(x,{gap:"2",align:"center",children:[e.jsx(c,{color:"gray",weight:"bold",children:"Created:"}),e.jsx(c,{children:new Date(t.creation).toLocaleString()})]})]})]}),e.jsxs(v,{children:[e.jsxs(x,{justify:"between",align:"center",mb:"4",children:[e.jsx(C,{size:"5",children:"Message Template"}),e.jsx(se,{content:"Show Jinja2 Help",children:e.jsx(g,{variant:"ghost",size:"1",onClick:()=>V(!z),children:e.jsx(Me,{})})})]}),d?e.jsxs(e.Fragment,{children:[z&&e.jsxs(v,{mb:"4",children:[e.jsx(C,{size:"3",mb:"2",children:"Jinja2 Template Help"}),e.jsx(c,{mb:"2",children:"You can use these variables and filters in your templates:"}),e.jsxs(ee,{columns:"2",gap:"3",children:[e.jsxs(v,{children:[e.jsx(C,{size:"3",children:"Variables"}),e.jsxs(c,{as:"div",mb:"2",children:[e.jsx("code",{children:"doc"})," - The document object",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.nowdate()"})," - Current date",e.jsx("br",{}),e.jsx("code",{children:"frappe.utils.get_url()"})," - System URL"]})]}),e.jsxs(v,{children:[e.jsx(C,{size:"3",children:"Common Examples"}),xe.map((a,j)=>e.jsxs(g,{variant:"soft",onClick:()=>r(h(o({},n),{message:n.message?`${n.message}
${a.value}`:a.value})),className:"mb-2",children:[e.jsx(ze,{className:"mr-2"})," ",a.label]},j))]})]})]}),e.jsx(He,{placeholder:`Example: Alert for {{ doc.name }}
Status: {{ doc.status }}
Value: {{ doc.value }}`,rows:8,value:n.message||"",onChange:a=>r(h(o({},n),{message:a.target.value}))})]}):e.jsx(v,{children:e.jsx(Pe,{style:{maxHeight:"300px"},children:e.jsx(c,{children:t.message})})})]}),e.jsxs(v,{children:[e.jsx(C,{size:"5",mb:"4",children:"Conditions"}),d?e.jsxs(e.Fragment,{children:[e.jsxs(ae,{children:[e.jsx(le,{children:e.jsxs(R,{children:[e.jsx(S,{children:"Field"}),e.jsx(S,{children:"Operator"}),e.jsx(S,{children:"Value"}),e.jsx(S,{children:"Actions"})]})}),e.jsxs(ne,{children:[A.map((a,j)=>e.jsxs(R,{children:[e.jsx(m,{children:a.field}),e.jsx(m,{children:a.operator}),e.jsx(m,{children:a.value}),e.jsx(m,{children:e.jsx(g,{variant:"ghost",color:"red",onClick:()=>{const N=[...A];N.splice(j,1),r(h(o({},n),{condition:N.map(b=>`doc.${b.field} ${b.operator} ${isNaN(Number(b.value))?`"${b.value}"`:b.value}`).join(" and ")}))},children:"Remove"})})]},j)),e.jsxs(R,{children:[e.jsx(m,{children:e.jsx(P,{placeholder:"Field name",value:f.field,onChange:a=>_(h(o({},f),{field:a.target.value}))})}),e.jsx(m,{children:e.jsxs(T,{value:f.operator,onValueChange:a=>_(h(o({},f),{operator:a})),children:[e.jsx(D,{}),e.jsx(M,{children:je.map(a=>e.jsx(w,{value:a.value,children:a.label},a.value))})]})}),e.jsx(m,{children:e.jsx(P,{placeholder:"Value",value:f.value,onChange:a=>_(h(o({},f),{value:a.target.value}))})}),e.jsx(m,{children:e.jsx(g,{onClick:()=>{const a=[...A,f];r(h(o({},n),{condition:a.map(j=>`doc.${j.field} ${j.operator} ${isNaN(Number(j.value))?`"${j.value}"`:j.value}`).join(" and ")})),_({field:"",operator:"==",value:""})},children:"Add"})})]})]})]}),A.length>0&&e.jsxs(v,{mt:"4",children:[e.jsx(C,{size:"2",children:"Generated Condition"}),e.jsx(c,{as:"div",children:n.condition})]})]}):e.jsx(x,{direction:"column",gap:"3",children:A.length>0?A.map((a,j)=>e.jsx(v,{children:e.jsxs(x,{gap:"3",children:[e.jsx(c,{weight:"bold",children:a.field}),e.jsx(c,{children:a.operator}),e.jsx(c,{children:a.value})]})},j)):e.jsx(c,{color:"gray",children:"No conditions defined"})})]}),e.jsxs(v,{children:[e.jsx(C,{size:"5",mb:"4",children:"Recipients"}),d?e.jsx(e.Fragment,{children:e.jsxs(ae,{children:[e.jsx(le,{children:e.jsxs(R,{children:[e.jsx(S,{children:"Role"}),e.jsx(S,{children:"Condition"}),e.jsx(S,{children:"Actions"})]})}),e.jsxs(ne,{children:[(n.recipients||[]).map((a,j)=>e.jsxs(R,{children:[e.jsx(m,{children:a.receiver_by_role}),e.jsx(m,{children:a.condition||"-"}),e.jsx(m,{children:e.jsx(g,{variant:"ghost",color:"red",onClick:()=>{const N=[...n.recipients||[]];N.splice(j,1),r(h(o({},n),{recipients:N}))},children:"Remove"})})]},j)),e.jsxs(R,{children:[e.jsx(m,{children:e.jsxs(T,{value:p.receiver_by_role,onValueChange:a=>F(h(o({},p),{receiver_by_role:a})),children:[e.jsx(D,{placeholder:"Select Role"}),e.jsx(M,{children:q==null?void 0:q.map(a=>e.jsx(w,{value:a.name,children:a.name},a.name))})]})}),e.jsx(m,{children:e.jsx(P,{placeholder:"Condition (optional)",value:p.condition,onChange:a=>F(h(o({},p),{condition:a.target.value}))})}),e.jsx(m,{children:e.jsx(g,{onClick:()=>{r(h(o({},n),{recipients:[...n.recipients||[],p]})),F({receiver_by_role:"",condition:""})},disabled:!p.receiver_by_role,children:"Add"})})]})]})]})}):e.jsx(x,{direction:"column",gap:"3",children:(t.recipients||[]).length>0?(t.recipients||[]).map((a,j)=>e.jsx(v,{children:e.jsxs(x,{justify:"between",align:"center",children:[e.jsx(c,{weight:"bold",children:a.receiver_by_role}),e.jsx(c,{color:"gray",children:a.condition||"No condition"})]})},j)):e.jsx(c,{color:"gray",children:"No recipients defined"})})]})]})]})};export{la as default};
